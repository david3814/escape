<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>막차를 놓치지 마! - 웹 방탈출</title>
    
    <style>
        /* --- CSS 코드 시작 --- */
        :root {
            --obj-hover-color: yellow;
        }

        body {
            margin: 0;
            font-family: 'Malgun Gothic', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #1a1a1a;
            color: #333;
            overflow: hidden; /* 스크롤 방지 */
        }

        /* --- [추가됨] 시작 화면 스타일 --- */
        #login-screen {
            width: 100%;
            height: 100%;
            background-color: #1a1a1a;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 200;
            position: absolute;
        }
        #login-screen h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        #login-screen p {
            font-size: 1.2em;
            color: #ccc;
            margin-bottom: 30px;
        }
        .login-input-group {
            margin-bottom: 20px;
        }
        .login-input-group input {
            padding: 12px;
            margin: 0 5px;
            border: 1px solid #555;
            border-radius: 5px;
            background-color: #333;
            color: white;
            width: 80px;
            text-align: center;
        }
        #player-name {
            width: 120px;
        }
        #start-game-btn {
            padding: 12px 30px;
            font-size: 1.2em;
            font-weight: bold;
        }

        /* --- 게임 컨테이너 (초기에는 숨김) --- */
        #game-container {
            position: relative;
            width: 1260px;
            height: 840px;
            max-width: 95vw;
            max-height: 63.33vw;
            display: none; /* JS로 보이게 변경 */
        }

        .room-bg {
            width: 100%;
            height: 100%;
            border-radius: 8px;
        }

        /* --- [추가됨] 타이머 & 자막 스타일 --- */
        #timer-display {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.8);
            color: #ff4757;
            font-size: 2em;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 101;
            font-family: 'Courier New', Courier, monospace;
        }

        #subtitle-container {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 1.2em;
            max-width: 80%;
            text-align: center;
            z-index: 101;
            opacity: 0;
            transition: opacity 0.5s;
        }
        #subtitle-container.visible {
            opacity: 1;
        }

        .clickable-object {
            position: absolute;
            background-color: rgba(255, 0, 0, 0);
            cursor: pointer;
            border: 3px dashed rgba(255, 255, 0, 0);
            transition: border 0.3s, background-color 0.3s;
            border-radius: 10px;
        }

        .clickable-object:hover {
            border: 3px dashed var(--obj-hover-color);
            background-color: rgba(255, 255, 0, 0.2);
        }

        #obj-newspaper { top: 52%; left: 70%; width: 20%; height: 36%; }
        #obj-logo { top: 59%; left: 17%; width: 6%; height: 10%; }
        #obj-woman { top: 41%; left: 55%; width: 4%; height: 12%; }
        #obj-map { top: 52%; left: 90%; width: 9%; height: 30%; }
        #obj-door { top: 38%; left: 21%; width: 13%; height: 58%; }

        #hint-display {
            position: absolute;
            bottom: 15px;
            left: 15px;
            background-color: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
        }
        #hint-display h3 { margin: 0 0 10px 0; }
        #hint-list { list-style: none; padding: 0; margin: 0; }

        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background-color: #f8f8f8;
            padding: 20px 30px;
            border-radius: 10px;
            text-align: center;
            width: 90%;
            max-width: 450px;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }
        .close-btn:hover { color: #333; }

        input[type="text"] {
            padding: 10px;
            margin-top: 10px;
            width: 80%;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        button {
            padding: 10px 20px;
            margin-top: 15px;
            border: none;
            border-radius: 5px;
            background-color: #5c67f2;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover { background-color: #4a54c2; }


        #memory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px auto;
            width: 280px;
        }
        .memory-card {
            width: 60px; height: 60px;
            background-color: #bbb;
            color: white;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border-radius: 5px;
            transform-style: preserve-3d;
            transition: transform 0.5s;
            position: relative;
        }
        .memory-card.is-flipped { transform: rotateY(180deg); }
        .memory-card.is-matched {
            transform: rotateY(180deg);
            background-color: #6aaa64;
            cursor: default;
        }
        .card-face { position: absolute; backface-visibility: hidden; }
        .card-back { transform: rotateY(180deg); }

        @keyframes fadeIn {
            from { opacity: 0; } to { opacity: 1; }
        }
        /* --- CSS 코드 끝 --- */
    </style>
</head>
<body>
    <!-- [추가됨] 시작 화면 -->
    <div id="login-screen">
        <h1>막차를 놓치지 마!</h1>
        <p>늦은 밤, 당신은 막차를 타고 무사히 집으로 돌아가야 합니다.</p>
        <div class="login-input-group">
            <input type="text" id="player-grade" placeholder="학년">
            <input type="text" id="player-class" placeholder="반">
            <input type="text" id="player-name" placeholder="이름">
        </div>
        <button id="start-game-btn">시작하기</button>
    </div>

    <!-- 게임 화면 -->
    <div id="game-container">
        <!-- [추가됨] 타이머, 자막 -->
        <div id="timer-display">00:00</div>
        <div id="subtitle-container"></div>

        <img src="https://i.ibb.co/zH0fJCTt/Whisk-storyboarda795102d420a41929fe5053d.jpg" alt="늦은 밤 지하철역" class="room-bg">

        <div class="clickable-object" id="obj-newspaper" title="신문 보는 남자"></div>
        <div class="clickable-object" id="obj-logo" title="열차 로고"></div>
        <div class="clickable-object" id="obj-woman" title="빨간 옷을 입은 여자"></div>
        <div class="clickable-object" id="obj-map" title="노선도"></div>
        <div class="clickable-object" id="obj-door" title="지하철 문"></div>

        <div id="hint-display">
            <h3>획득한 단서</h3>
            <ul id="hint-list"></ul>
        </div>
    </div>

    <!-- 모달들 -->
    <div id="quiz1-modal" class="modal"><div class="modal-content"><span class="close-btn">×</span><h2>첫 번째 문제</h2><p>신문에 '마지막 열차'에 대한 기사가 실려있다.<br>'막차'를 영어로 쓰시오. (두 단어, 소문자로)</p><input type="text" id="quiz1-answer" placeholder="정답 입력"><button id="submit-quiz1">제출</button></div></div>
    <div id="hint1-modal" class="modal"><div class="modal-content"><span class="close-btn">×</span><h2>힌트</h2><p>열차 로고가 빛나고 있다.<br>"서두르세요! 곧 출발합니다. 잊으신 물건은 없으신가요?"</p></div></div>
    <div id="quiz2-modal" class="modal"><div class="modal-content"><span class="close-btn">×</span><h2>두 번째 문제</h2><p>저 멀리 서 있는 여자가 입은 옷은 무슨 색인가?</p><input type="text" id="quiz2-answer" placeholder="정답 입력"><button id="submit-quiz2">제출</button></div></div>
    <div id="memory-game-modal" class="modal"><div class="modal-content"><span class="close-btn">×</span><h2>메모리 게임</h2><p>복잡한 노선도다. 같은 역 이름 카드를 맞추자!</p><div id="memory-grid"></div></div></div>
    <div id="escape-modal" class="modal"><div class="modal-content"><span class="close-btn">×</span><h2>탈출</h2><p>모든 단서를 조합하여 4자리 비밀번호를 입력하고 열차에 탑승하세요.</p><input type="text" id="final-password" maxlength="4" placeholder="****"><button id="submit-escape">탑승하기</button></div></div>

    <script>
        // --- JAVASCRIPT 코드 시작 ---
        document.addEventListener('DOMContentLoaded', () => {

            // --- 게임 상태 관리 ---
            const gameState = {
                solved: { newspaper: false, logo: false, woman: false, map: false },
                hints: [],
                player: { grade: '', class: '', name: '' },
                timer: { interval: null, startTime: 0 }
            };

            // --- DOM 요소 가져오기 ---
            const loginScreen = document.getElementById('login-screen');
            const gameContainer = document.getElementById('game-container');
            const hintList = document.getElementById('hint-list');
            const timerDisplay = document.getElementById('timer-display');
            const subtitleContainer = document.getElementById('subtitle-container');
            
            const modals = {
                quiz1: document.getElementById('quiz1-modal'),
                hint1: document.getElementById('hint1-modal'),
                quiz2: document.getElementById('quiz2-modal'),
                memory: document.getElementById('memory-game-modal'),
                escape: document.getElementById('escape-modal')
            };

            // --- [추가됨] 게임 시작 처리 ---
            document.getElementById('start-game-btn').addEventListener('click', () => {
                gameState.player.grade = document.getElementById('player-grade').value || ' ';
                gameState.player.class = document.getElementById('player-class').value || ' ';
                gameState.player.name = document.getElementById('player-name').value;

                if (!gameState.player.name) {
                    alert('이름을 입력해주세요!');
                    return;
                }
                
                loginScreen.style.display = 'none';
                gameContainer.style.display = 'block';

                startGame();
            });

            function startGame() {
                gameState.timer.startTime = Date.now();
                gameState.timer.interval = setInterval(updateTimer, 1000);
                showSubtitle("늦은 밤... 막차 시간이 얼마 남지 않았다. 서둘러야 해!", 5000);
            }

            // --- [추가됨] 타이머 & 자막 함수 ---
            const pad = (num) => String(num).padStart(2, '0');

            function updateTimer() {
                const elapsedSeconds = Math.floor((Date.now() - gameState.timer.startTime) / 1000);
                const minutes = pad(Math.floor(elapsedSeconds / 60));
                const seconds = pad(elapsedSeconds % 60);
                timerDisplay.textContent = `${minutes}:${seconds}`;
            }

            let subtitleTimeout;
            function showSubtitle(text, duration) {
                clearTimeout(subtitleTimeout);
                subtitleContainer.textContent = text;
                subtitleContainer.classList.add('visible');
                subtitleTimeout = setTimeout(() => {
                    subtitleContainer.classList.remove('visible');
                }, duration);
            }

            // --- 모달 제어 함수 ---
            const showModal = (modal) => modal.style.display = 'flex';
            const hideModal = (modal) => modal.style.display = 'none';

            document.querySelectorAll('.modal').forEach(modal => {
                modal.querySelector('.close-btn')?.addEventListener('click', () => hideModal(modal));
                modal.addEventListener('click', e => { if (e.target === modal) hideModal(modal); });
            });

            // --- 힌트 관리 함수 ---
            const addHint = (text) => {
                if (gameState.hints.includes(text)) return;
                gameState.hints.push(text);
                const li = document.createElement('li');
                li.textContent = `- ${text}`;
                hintList.appendChild(li);
            };
            
            // --- 오브젝트 클릭 이벤트 ---
            document.getElementById('obj-newspaper').addEventListener('click', () => {
                if (gameState.solved.newspaper) return showSubtitle('신문은 이미 다 읽었다.', 3000);
                showModal(modals.quiz1);
            });
            document.getElementById('obj-logo').addEventListener('click', () => {
                showModal(modals.hint1);
                if (!gameState.solved.logo) {
                    addHint("물건을 잊지 말라는 안내방송이 나왔다.");
                    gameState.solved.logo = true;
                }
            });
            document.getElementById('obj-woman').addEventListener('click', () => {
                if (gameState.solved.woman) return showSubtitle('더 이상 저 여자에게선 얻을 정보가 없어 보인다.', 3000);
                showModal(modals.quiz2);
            });
            document.getElementById('obj-map').addEventListener('click', () => {
                if (gameState.solved.map) return showSubtitle('노선도는 이제 익숙하다.', 3000);
                initializeMemoryGame();
                showModal(modals.memory);
            });
            document.getElementById('obj-door').addEventListener('click', () => {
                if (!gameState.solved.newspaper || !gameState.solved.woman || !gameState.solved.map) {
                    return showSubtitle('아직 단서가 부족해 문을 열 수 없다. 주변을 더 둘러보자.', 4000);
                }
                showSubtitle('모든 단서를 모은 것 같다. 비밀번호를 입력하자!', 4000);
                showModal(modals.escape);
            });

            // --- 문제 및 게임 로직 ---
            document.getElementById('submit-quiz1').addEventListener('click', () => {
                const answer = document.getElementById('quiz1-answer').value.toLowerCase().trim();
                if (answer === 'last train') {
                    showSubtitle('정답이야! 첫 번째 단서를 얻었다.', 3000);
                    addHint("비밀번호의 첫 두 자리는 08이다.");
                    gameState.solved.newspaper = true;
                    hideModal(modals.quiz1);
                } else {
                    showSubtitle('틀린 것 같다... 신문을 다시 잘 읽어보자.', 3000);
                }
            });
            
            document.getElementById('submit-quiz2').addEventListener('click', () => {
                const answer = document.getElementById('quiz2-answer').value.trim();
                if (answer === '빨간색' || answer === '빨강') {
                    showSubtitle('맞아, 저건 빨간색이야. 단서를 찾았다!', 3000);
                    addHint("비밀번호의 마지막 자리는 4이다.");
                    gameState.solved.woman = true;
                    hideModal(modals.quiz2);
                } else {
                    showSubtitle('저 색이 아닌데... 눈을 가늘게 뜨고 다시 보자.', 3000);
                }
            });

            const memoryGrid = document.getElementById('memory-grid');
            const cardValues = ['서울역', '용산', '시청', '신도림', '서울역', '용산', '시청', '신도림'];
            let flippedCards = [];
            let matchedPairs = 0;

            function initializeMemoryGame() {
                matchedPairs = 0;
                flippedCards = [];
                memoryGrid.innerHTML = '';
                cardValues.sort(() => 0.5 - Math.random());
                cardValues.forEach(value => {
                    const card = document.createElement('div');
                    card.classList.add('memory-card');
                    card.dataset.value = value;
                    card.innerHTML = `<div class="card-face card-front">?</div><div class="card-face card-back">${value}</div>`;
                    card.addEventListener('click', () => flipCard(card));
                    memoryGrid.appendChild(card);
                });
            }

            function flipCard(card) {
                if (flippedCards.length < 2 && !card.classList.contains('is-flipped') && !card.classList.contains('is-matched')) {
                    card.classList.add('is-flipped');
                    flippedCards.push(card);
                    if (flippedCards.length === 2) setTimeout(checkForMatch, 700);
                }
            }

            function checkForMatch() {
                const [card1, card2] = flippedCards;
                if (card1.dataset.value === card2.dataset.value) {
                    card1.classList.add('is-matched');
                    card2.classList.add('is-matched');
                    matchedPairs++;
                    if (matchedPairs === cardValues.length / 2) {
                        setTimeout(() => {
                            showSubtitle('해냈다! 복잡한 노선도에서 마지막 단서를 찾았어.', 4000);
                            addHint("비밀번호의 세 번째 자리는 1이다.");
                            gameState.solved.map = true;
                            hideModal(modals.memory);
                        }, 300);
                    }
                } else {
                    card1.classList.remove('is-flipped');
                    card2.classList.remove('is-flipped');
                }
                flippedCards = [];
            }
            
            // --- 최종 탈출 로직 ---
            document.getElementById('submit-escape').addEventListener('click', () => {
                const password = document.getElementById('final-password').value;
                if (password === '0814') {
                    clearInterval(gameState.timer.interval); // 타이머 중지
                    const finalTime = timerDisplay.textContent;
                    
                    document.body.innerHTML = `
                        <div style="color:white; text-align:center; padding-top: 30vh;">
                            <h1>탈출 성공!</h1>
                            <p>${gameState.player.grade}학년 ${gameState.player.class}반 ${gameState.player.name}님, 막차에 무사히 탑승했습니다!</p>
                            <p>기록: ${finalTime}</p>
                        </div>
                    `;
                } else {
                    showSubtitle('비밀번호가 틀렸어! 획득한 단서들을 다시 조합해보자.', 4000);
                }
            });
        });
        // --- JAVASCRIPT 코드 끝 ---
    </script>
</body>
</html>